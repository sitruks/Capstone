---
title: "NCAA_Capstone"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r }
library(data.table)
library(magrittr)
library(ggplot2)
library(dplyr)
library(stringr)
library(ggplot2)
library(gridExtra)
library(ggExtra)
library(GGally)
```
## Get data

```{r}

teams <- read.csv("Data/Teams.csv")

seasons <- read.csv("Data/Seasons.csv")

seeds <- read.csv("Data/NCAATourneySeeds.csv")

conferences <- read.csv("Data/Conferences.csv")

coaches <- read.csv("Data/TeamCoaches.csv")

team_conferences <- read.csv("Data/TeamConferences.csv")
  
tour_compact_res <- read.csv("Data/NCAATourneyCompactResults.csv")

tour_detail_res <- read.csv("Data/NCAATourneyDetailedResults.csv")

seas_compact_res <- read.csv("Data/RegularSeasonCompactResults.csv")

seas_detail_res <- read.csv("Data/RegularSeasonDetailedResults.csv")

```
## Data Exploration

```{r}
head(teams,n=5)
head(seasons,n=5)
head(seeds,n=5)
head(conferences,n=5)
head(coaches,n=5)
head(team_conferences,n=5)
head(tour_compact_res,n=5)
head(tour_detail_res,n=5)
head(seas_compact_res,n=5)
head(seas_detail_res,n=5)


```

## Prepare Target Label
We train a model to predict tournment win/lose
and randomize the winner and loser team into team 1 and 2 and we calculate the probability of team 1 wins.


We randomize winning and losing team into team 1 and team 2 (necessary for probabilities later) and drop other ids
```{r}
rand_tourn_res <- tour_compact_res %>% select(Season,DayNum,WTeamID,LTeamID) %>% mutate(rand = runif(dim(tour_compact_res)[1]), 
         team1id = ifelse(rand >= 0.5, WTeamID, LTeamID),
         team2id = ifelse(rand <0.5, WTeamID, LTeamID),
         team1win = ifelse(team1id == WTeamID, 1, 0)) %>% 
  select(-rand, -WTeamID,-LTeamID)


seeds_tournment <- seeds %>% mutate(ranking = as.factor((str_replace(Seed, "[A-Z]",""))), 
         rank_num = as.numeric(str_replace(ranking, ".[a-z]","")))

```
Add seeding information to games as seeding can be an important predictor
```{r}

rand_tourn_res <- rand_tourn_res %>% 
  left_join(
    select(seeds_tournment, t1_rank = ranking, t1_rank_n = rank_num, TeamID, Season), 
    by = c("team1id"="TeamID","Season"="Season")) 

rand_tourn_res <- rand_tourn_res %>% 
  left_join(
    select(seeds_tournment, t2_rank = ranking, t2_rank_n = rank_num, TeamID, Season), 
    by = c("team2id"="TeamID","Season"="Season")) 

rand_tourn_res <- rand_tourn_res %>% mutate(t1_rank = ifelse(is.na(t1_rank), 8, t1_rank),
                                                    t2_rank = ifelse(is.na(t2_rank), 8, t2_rank),
                                                    t1_rank_n = ifelse(is.na(t1_rank_n), 8, t1_rank_n),
                                                    t2_rank_n = ifelse(is.na(t2_rank_n), 8, t2_rank_n),
                                                    diff_rank = t1_rank_n - t2_rank_n)


```




Letâ€™s now turn to the regular season game statistics. We are interested in knowing how certain statistics correlate with winning vs losing.

```{r}
win_predictors <- seas_detail_res %>% select(Season,starts_with("W"))
win_predictors$Res = 1
names(win_predictors) = substring(names(win_predictors),2)
win_predictors <- win_predictors%>% select(-Loc)
lose_predictors <- seas_detail_res %>% select(Season,starts_with("L"))
lose_predictors$Res = 0
names(lose_predictors) = substring(names(lose_predictors),2)
predictors_all <- rbindlist(list(win_predictors, lose_predictors))
predictors_all <- predictors_all %>% rename(Season = eason, Res = es)
predictors_all <- predictors_all %>% mutate(FGP = FGM/FGA,FGP2 = (FGM - FGM3) / (FGA - FGA3),FGP3 = FGM3 / FGA3,FTP = FTM / FTA)
predictors_all <- predictors_all%>%mutate(Res = factor(ifelse(Res == 1, 'W','L')))
predictors_all <- predictors_all%>%mutate(Outcome = ifelse(Res == 'W', 1,0))

```

Create mean stats for each season, each team
```{r}
mean_predictors <- predictors_all %>% group_by(Season,TeamID) %>% summarise_all(funs(mean))
```
Join with the tournament results dataframe

```{r}
model_df <- rand_tourn_res %>%  inner_join(
    mean_predictors,
    by = c("team1id"="TeamID","Season"="Season")) 

model_df <- model_df %>%  inner_join(
    mean_predictors,
    by = c("team2id"="TeamID","Season"="Season")) 

names(model_df) <- gsub('.x','_t1',names(model_df))
names(model_df) <- gsub('.y','_t2',names(model_df))

```

## Cross validation Model

``` {r}

model_df <- model_df[!is.na(model_df$team1win),]

y <- model_df[,"team1win"]
X <- model_df[,-c(1:5)]
# train_set <- createDataPartition(y, p = 0.8, list = FALSE)
# 
# train_X <- X[train_set, ]
# train_y <- y[train_set]
# test_X <- X[-train_set, ]
# test_y <- y[-train_set]
#  
# set.seed(seed)
# cv_splits <- createFolds(y, k = 10, returnTrain = TRUE)

 	
library(caret)
library(glmnet)
glmnet_grid <- expand.grid(alpha = c(0,  .1,  .2, .4, .6, .8, 1),
                           lambda = seq(.01, .2, length = 20))
glmnet_ctrl <- trainControl(method = "cv", number = 10)
glmnet_fit <- train(team1win ~ ., data = model_df%>%select(-c('Season','D_t2Num','team1id','team2id','Res_t2','Res_t1')),
                    method = "glmnet",
                    preProcess = c("center", "scale"),
                    tuneGrid = glmnet_grid,
                    trControl = glmnet_ctrl)
glmnet_fit

## Simple logistic regression
model <- glm(team1win ~ ., data = model_df%>%select(-c('Season','D_t2Num','team1id','team2id','Res_t2','Res_t1')), family = binomial)
summary(model)



```

## Compute distance bewteen game location to each team's home venue
skip for now, need to know how the home venue location was generated for each team
```{r}
library(geosphere)
#distm(c(lon1, lat1), c(lon2, lat2), fun = distHaversine)

```

## Visualization plots
```{r}

g1 <- predictors_all %>%
    ggplot(aes(x = FGP, fill = Res)) +
    geom_density(alpha = 0.7) +
    scale_fill_manual(values = c('darkblue', 'grey')) + 
    labs(x = 'Field goal %', y = '', title = 'Field Goal Shooting')

# Correlation plot
cor <- round(cor(predictors_all),1)
library(ggcorrplot)
ggcorrplot(corr, hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="circle", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of mtcars", 
           ggtheme=theme_bw)

# Scatter plot
theme_set(theme_bw())
g <- ggplot(predictors_all, aes(Outcome, FGP)) + 
  geom_count() + 
  geom_smooth(method="lm", se=F)

ggMarginal(g, type = "histogram", fill="transparent")
ggMarginal(g, type = "boxplot", fill="transparent")


# Bars
teams <- data.table(teams)
seeds <- data.table(seeds)
seas_compact_res <- data.table(seas_compact_res)
tour_compact_res <- data.table(tour_compact_res)

setkey(teams, TeamID)
setkey(seeds, TeamID)


g1 <-
    teams[seeds][, one_seed := as.numeric(substr(Seed, 2, 3)) == 1][, sum(one_seed), by = TeamName][order(V1, decreasing = T)][1:30,] %>%
    ggplot(aes(x = reorder(TeamName, V1), y = V1,label = V1)) + geom_text(color="white", size=2) +
    geom_point(stat = 'identity', fill = 'darkblue',size = 4) + geom_segment(aes(y=0,x = reorder(TeamName, V1), yend = V1,xend =reorder(TeamName, V1) ),color = 'black') +
    labs(x = '', y = 'No 1 seeds', title = 'No. 1 Seeds since 1985') +
    coord_flip()

setkey(seas_compact_res,WTeamID)
g2 <-
    seas_compact_res[teams][, .(wins = .N), by = TeamName][order(-wins)][1:30,] %>%
    ggplot(aes(x = reorder(TeamName, wins), y = wins,label = wins)) + geom_text(color="white", size=2) +
    geom_point(stat = 'identity', fill = 'darkblue',size = 4) + geom_segment(aes(y=0,x = reorder(TeamName,wins), yend = wins,xend =reorder(TeamName, wins) ),color = 'black') +
    labs(x = '', y = 'Wins', title = 'Regular Season Wins since 1985') +
    coord_flip()

setkey(tour_compact_res, WTeamID)

g3 <-
    tour_compact_res[teams][, .(wins = .N), by = TeamName][order(-wins)][1:30,] %>%
    ggplot(aes(x = reorder(TeamName, wins), y = wins,label = wins)) + geom_text(color="white", size=2) +
    geom_point(stat = 'identity', fill = 'darkblue',size = 4) + geom_segment(aes(y=0,x = reorder(TeamName,wins), yend = wins,xend =reorder(TeamName, wins) ),color = 'black') +
    labs(x = '', y = 'Wins', title = 'Tournament Wins since 1985') +
    coord_flip()

g4 <-
    tour_compact_res[teams][DayNum == 154, .(wins = .N), by = TeamName][order(-wins)][0:30,] %>%
    ggplot(aes(x = reorder(TeamName, wins), y = wins,label = wins)) + geom_text(color="white", size=2)+ geom_point(stat = 'identity', fill = 'darkblue',size = 4) +
    geom_segment(aes(y=0,x = reorder(TeamName,wins), yend = wins,xend =reorder(TeamName, wins) ),color = 'black') +
    labs(x = '', y = 'Championships', title = 'Tournament Championships since 1985') +
    coord_flip()


## Conferences analysis
conf_analysis <- tour_compact_res[team_conferences, on = c(WTeamID = 'TeamID', 'Season'), nomatch = 0
             ][DayNum == 154, .(ConfAbbrev, wins = .N), by = ConfAbbrev
               ][conferences, on = 'ConfAbbrev', nomatch = 0] 
conf_analysis$overall_type <- ifelse(conf_analysis$wins < 4, "below", "above")
conf_analysis <- conf_analysis[order(conf_analysis$wins),]
conf_analysis$`Description` <- factor(conf_analysis$`Description`, levels = conf_analysis$`Description`)

ggplot(conf_analysis, aes(x=`Description`, y=wins, label=wins)) + 
  geom_point(stat='identity', aes(col=overall_type), size=6)  +
  scale_color_manual(name="Champion wins", 
                     labels = c("Above Average", "Below Average"), 
                     values = c("above"="#00ba38", "below"="#f8766d")) + 
  geom_text(color="white", size=2) +
  labs(title="Diverging Dot Plot", 
       subtitle="Champion Wins by Conferences") + 
  ylim(0, 12) +
  coord_flip()

```
## Including Plots



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
